---
title: "Setup Project Environment"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = TRUE, warning = TRUE)
```

## Project Setup

This notebook verifies the R environment and installs all required packages for the LLM text extraction project.

### Purpose

Before beginning any extraction work, we need to ensure:
- Required R packages are installed
- API keys are properly configured
- Project directories exist
- R environment is correctly set up

## Check R Version

Current R installation details.

```{r check-r-version}
cat("R version:", R.version.string, "\n")
cat("Platform:", R.version$platform, "\n")
cat("Working directory:", getwd(), "\n")
```

**Result**: R environment information displayed.

## Required Packages

The project requires these packages for LLM extraction and analysis.

```{r package-list}
required_packages <- c(
  "ellmer",        # Google Gemini API interface
  "dplyr",         # Data manipulation
  "tidyr",         # Data tidying
  "stringr",       # String operations
  "ggplot2",       # Visualization
  "jsonlite",      # JSON parsing
  "readr",         # File reading
  "purrr",         # Functional programming
  "tidytext",      # Text mining
  "topicmodels",   # LDA topic modeling
  "wordcloud"      # Word cloud visualizations
)

cat("Required packages:\n")
print(required_packages)
```

**Result**: List of eleven required packages defined.

## Check Installed Packages

Identify which packages are already installed versus missing.

```{r check-packages}
installed <- sapply(required_packages, function(pkg) {
  requireNamespace(pkg, quietly = TRUE)
})

cat("\nPackage Status:\n")
cat(rep("-", 40), "\n", sep = "")
for (i in seq_along(required_packages)) {
  status <- if (installed[i]) "✓ Installed" else "✗ Missing"
  cat(sprintf("%-20s %s\n", required_packages[i], status))
}

missing_packages <- required_packages[!installed]
cat(rep("-", 40), "\n", sep = "")
cat(sprintf("\nMissing packages: %d\n", length(missing_packages)))
```

**Result**: Package installation status checked.

## Install Missing Packages

Install any packages that are not yet installed.

```{r install-packages}
if (length(missing_packages) > 0) {
  cat("\nInstalling missing packages...\n")

  for (pkg in missing_packages) {
    cat(sprintf("  Installing %s...\n", pkg))
    install.packages(pkg, repos = "https://cloud.r-project.org", quiet = TRUE)
  }

  cat("\n✓ Package installation complete\n")
} else {
  cat("\n✓ All required packages are already installed\n")
}
```

**Result**: Missing packages installed from CRAN.

## Verify Package Loading

Test that all packages can be loaded successfully.

```{r load-packages}
cat("\nLoading packages...\n")
load_success <- sapply(required_packages, function(pkg) {
  result <- tryCatch({
    library(pkg, character.only = TRUE)
    TRUE
  }, error = function(e) {
    cat(sprintf("  ✗ Failed to load %s: %s\n", pkg, conditionMessage(e)))
    FALSE
  })
  result
})

if (all(load_success)) {
  cat("✓ All packages loaded successfully\n")
} else {
  failed <- required_packages[!load_success]
  cat(sprintf("✗ Failed to load: %s\n", paste(failed, collapse = ", ")))
}
```

**Result**: All packages loaded and verified.

## Check API Key Configuration

Verify that the Google Gemini API key is configured.

```{r check-api-key}
# Load .env file if it exists
if (file.exists(".env")) {
  readRenviron(".env")
  cat("✓ Loaded .env file\n")
} else {
  cat("⚠ No .env file found in project directory\n")
}

# Check API key
api_key <- Sys.getenv("GOOGLE_API_KEY")
api_key_set <- nchar(api_key) > 0

cat("\nAPI Key Status:\n")
cat(rep("-", 40), "\n", sep = "")
cat("GOOGLE_API_KEY:", ifelse(api_key_set, "✓ SET", "✗ NOT SET"), "\n")

if (api_key_set) {
  cat("Key length:", nchar(api_key), "characters\n")
  cat("Key preview:", substr(api_key, 1, 10), "...\n")
} else {
  cat("\nTo set up your API key:\n")
  cat("1. Get a key from: https://makersuite.google.com/app/apikey\n")
  cat("2. Create a .env file in the project root\n")
  cat("3. Add: GOOGLE_API_KEY=your_key_here\n")
}
cat(rep("-", 40), "\n", sep = "")
```

**Result**: API key configuration status displayed.

## Check Project Directory Structure

Verify that required directories exist for data, cache, and logs.

```{r check-directories}
required_dirs <- c(
  "data",
  "data/cache",
  "data/logs",
  "data/fusarium",
  "R",
  "notebooks",
  "results",
  "dev"
)

cat("\nProject Directory Structure:\n")
cat(rep("-", 40), "\n", sep = "")

for (dir_path in required_dirs) {
  exists <- dir.exists(dir_path)
  status <- if (exists) "✓" else "✗"
  cat(sprintf("%s %-20s\n", status, dir_path))

  # Create if missing
  if (!exists) {
    dir.create(dir_path, showWarnings = FALSE, recursive = TRUE)
    cat(sprintf("    Created: %s\n", dir_path))
  }
}

cat(rep("-", 40), "\n", sep = "")
cat("✓ All required directories exist\n")
```

**Result**: Directory structure verified and created as needed.

## Source Project Functions

Load custom R functions from the R/ directory.

```{r source-functions}
r_files <- c(
  "R/utils.R",
  "R/retry_logic.R",
  "R/batch_processor.R",
  "R/cache_manager.R",
  "R/gemini_extraction.R",
  "R/extractors.R",
  "R/evaluation.R"
)

cat("\nLoading project functions:\n")
cat(rep("-", 40), "\n", sep = "")

for (r_file in r_files) {
  if (file.exists(r_file)) {
    source(r_file)
    cat(sprintf("✓ Loaded: %s\n", r_file))
  } else {
    cat(sprintf("⚠ Missing: %s\n", r_file))
  }
}

cat(rep("-", 40), "\n", sep = "")
```

**Result**: Project functions loaded into R session.

## Environment Summary

Display final setup status.

```{r summary}
cat("\n")
cat("╔════════════════════════════════════════╗\n")
cat("║     ENVIRONMENT SETUP COMPLETE         ║\n")
cat("╚════════════════════════════════════════╝\n")
cat("\n")

cat("Status Summary:\n")
cat(rep("-", 40), "\n", sep = "")
cat("R Version:       ", R.version.string, "\n")
cat("Packages:        ", ifelse(all(load_success), "✓ All loaded", "⚠ Some failed"), "\n")
cat("API Key:         ", ifelse(api_key_set, "✓ Configured", "✗ Not set"), "\n")
cat("Directories:     ✓ Ready\n")
cat("Functions:       ✓ Loaded\n")
cat(rep("-", 40), "\n", sep = "")

ready_for_work <- all(load_success) && api_key_set

if (ready_for_work) {
  cat("\n✓ Environment is ready for LLM extraction work!\n")
  cat("  Next: Run notebook 0010_test_gemini_api.Rmd\n")
} else {
  cat("\n⚠ Some setup items need attention:\n")
  if (!all(load_success)) {
    cat("  - Fix package loading errors\n")
  }
  if (!api_key_set) {
    cat("  - Configure GOOGLE_API_KEY in .env file\n")
  }
}
```

**Result**: Environment setup status summarized.

## Next Steps

1. If API key is not set, obtain one from Google AI Studio
2. Create `.env` file with your API key
3. Proceed to `0010_test_gemini_api.Rmd` to test API connectivity
4. Continue with `0020_toy_example_extraction.Rmd` for basic extraction concepts

## Configuration Notes

### API Key Security

The `.env` file is in `.gitignore` to prevent accidental commits of API keys to version control. Never hardcode API keys in notebooks or scripts.

### Package Versions

This project uses the latest CRAN versions of all packages. If you encounter compatibility issues, check `renv.lock` for specific version requirements.

### Directory Structure

The data directories (`cache`, `logs`, `fusarium`) are also in `.gitignore` to avoid committing large data files. Only `.gitkeep` files are tracked to preserve directory structure.
