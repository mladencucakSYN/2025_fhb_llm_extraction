---
title: "Aggregate Extraction Results"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(knitr)
```

## Overview

This notebook aggregates all extraction results into analysis-ready datasets for research use.

## Load Packages and Data

```{r load-packages}
library(dplyr)
library(tidyr)
library(readr)

data_dir <- "../data/fusarium"
```

```{r load-data}
all_results <- readRDS(file.path(data_dir, "batch_extraction_results_demo.rds"))

tibble(
  Dataset = "Extraction results",
  Records = nrow(all_results)
) %>% kable()
```

## Create Document-Level Summary

```{r document-summary}
doc_summary <- all_results %>%
  mutate(
    n_species = sapply(fusarium_species, length),
    n_crops = sapply(crop, length),
    n_abiotic = sapply(abiotic_factors, length),
    n_mycotoxins = sapply(mycotoxins, length),
    n_practices = sapply(agronomic_practices, length),
    has_data = n_species > 0 | n_crops > 0 | n_abiotic > 0
  )

tibble(
  Metric = c(
    "Total documents",
    "With species data",
    "With crop data",
    "With abiotic factors",
    "Modeling studies"
  ),
  Count = c(
    nrow(doc_summary),
    sum(doc_summary$n_species > 0),
    sum(doc_summary$n_crops > 0),
    sum(doc_summary$n_abiotic > 0),
    sum(doc_summary$modeling)
  )
) %>% kable()
```

## Create Species-Crop Combinations

```{r species-crop}
species_crop <- all_results %>%
  select(id, fusarium_species, crop) %>%
  unnest(fusarium_species) %>%
  unnest(crop) %>%
  mutate(
    fusarium_species = tolower(fusarium_species),
    crop = tolower(crop)
  )

if (nrow(species_crop) > 0) {
  tibble(
    Metric = c("Total combinations", "Unique species", "Unique crops"),
    Count = c(
      nrow(species_crop),
      n_distinct(species_crop$fusarium_species),
      n_distinct(species_crop$crop)
    )
  ) %>% kable()
}
```

## Create Abiotic Factors Dataset

```{r abiotic-factors}
abiotic_flat <- all_results %>%
  select(id, abiotic_factors) %>%
  unnest(abiotic_factors) %>%
  mutate(abiotic_factors = tolower(abiotic_factors))

if (nrow(abiotic_flat) > 0) {
  abiotic_counts <- abiotic_flat %>%
    count(abiotic_factors, sort = TRUE) %>%
    head(10)

  abiotic_counts %>% kable(caption = "Top 10 Abiotic Factors")
}
```

## Save Aggregated Datasets

```{r save-datasets}
outputs <- tibble(
  Dataset = character(),
  Path = character(),
  Records = integer()
)

# Save document summary
write_csv(doc_summary, file.path(data_dir, "extraction_summary.csv"))
outputs <- bind_rows(outputs, tibble(
  Dataset = "Document summary",
  Path = "extraction_summary.csv",
  Records = nrow(doc_summary)
))

# Save species-crop combinations
if (nrow(species_crop) > 0) {
  write_csv(species_crop, file.path(data_dir, "species_crop_combinations.csv"))
  outputs <- bind_rows(outputs, tibble(
    Dataset = "Species-crop combinations",
    Path = "species_crop_combinations.csv",
    Records = nrow(species_crop)
  ))
}

# Save abiotic factors
if (nrow(abiotic_flat) > 0) {
  write_csv(abiotic_flat, file.path(data_dir, "abiotic_factors_long.csv"))
  outputs <- bind_rows(outputs, tibble(
    Dataset = "Abiotic factors",
    Path = "abiotic_factors_long.csv",
    Records = nrow(abiotic_flat)
  ))
}

# Save complete structured data
saveRDS(all_results, file.path(data_dir, "extraction_results_final.rds"))
outputs <- bind_rows(outputs, tibble(
  Dataset = "Complete results",
  Path = "extraction_results_final.rds",
  Records = nrow(all_results)
))

outputs %>% kable()
```

## Dataset Uses

```{r dataset-uses}
tibble(
  Dataset = c(
    "extraction_summary.csv",
    "species_crop_combinations.csv",
    "abiotic_factors_long.csv",
    "extraction_results_final.rds"
  ),
  `Use Case` = c(
    "Document-level overview, quick filtering",
    "Species-crop association analysis",
    "Environmental factor frequency analysis",
    "Complete data for custom analysis"
  )
) %>% kable()
```

## Next Steps

Proceed to `0530_fusarium_analysis.Rmd` for research analysis.
