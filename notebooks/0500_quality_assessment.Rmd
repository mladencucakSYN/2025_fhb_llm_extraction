---
title: "Quality Assessment of Extractions"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(knitr)
```

## Overview

This notebook performs quality assessment on extracted data by comparing against manual annotations and identifying patterns in extraction errors.

## Load Packages and Data

```{r load-packages}
library(dplyr)
library(ggplot2)

data_dir <- "../data/fusarium"
```

```{r load-data}
all_results <- readRDS(file.path(data_dir, "batch_extraction_results_demo.rds"))

tibble(
  Dataset = "Extraction results",
  Records = nrow(all_results)
) %>% kable()
```

## Gold Standard Framework

For a subset of documents, create manual annotations to evaluate accuracy.

```{r gold-standard}
gold_standard <- tibble(
  id = all_results$id[1:3],
  manual_species = list(
    c("Fusarium graminearum"),
    c("Fusarium culmorum", "Fusarium avenaceum"),
    c("Fusarium graminearum")
  ),
  manual_crop = list(
    c("wheat"),
    c("barley"),
    c("wheat", "barley")
  )
)

tibble(
  Metric = c("Gold standard documents", "Target for validation"),
  Value = c(nrow(gold_standard), "20-50 documents")
) %>% kable()
```

## Calculate Extraction Success Rates

```{r calculate-metrics, fig.width=10, fig.height=5}
extraction_rates <- all_results %>%
  summarise(
    Species = mean(sapply(fusarium_species, length) > 0) * 100,
    Crops = mean(sapply(crop, length) > 0) * 100,
    `Abiotic Factors` = mean(sapply(abiotic_factors, length) > 0) * 100,
    Mycotoxins = mean(sapply(mycotoxins, length) > 0) * 100,
    Practices = mean(sapply(agronomic_practices, length) > 0) * 100
  ) %>%
  tidyr::pivot_longer(everything(), names_to = "Field", values_to = "Success_Rate")

ggplot(extraction_rates, aes(x = reorder(Field, Success_Rate), y = Success_Rate)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = paste0(round(Success_Rate, 1), "%")), hjust = -0.1) +
  coord_flip() +
  labs(
    title = "Extraction Success Rates by Field",
    x = "Field",
    y = "Success Rate (%)"
  ) +
  theme_minimal() +
  expand_limits(y = 100)

extraction_rates %>%
  mutate(Success_Rate = paste0(round(Success_Rate, 1), "%")) %>%
  kable()
```

## Quality Assessment Framework

```{r quality-framework}
tibble(
  Step = c(1, 2, 3, 4, 5),
  Task = c(
    "Manually annotate 20-50 documents",
    "Compare extractions against manual annotations",
    "Calculate precision and recall per field",
    "Identify patterns in extraction errors",
    "Refine prompts for low-performing fields"
  ),
  Status = c("TODO", "TODO", "TODO", "TODO", "TODO")
) %>% kable(caption = "Quality Assessment Workflow")
```

## Recommendations

```{r recommendations}
tibble(
  Recommendation = c(
    "Manually annotate 20-50 documents",
    "Calculate precision/recall per field",
    "Refine prompts for low-performing fields",
    "Re-extract problematic documents"
  ),
  Priority = c("High", "High", "Medium", "Low")
) %>% kable()
```

## Next Steps

Proceed to `0510_manual_validation.Rmd` for manual validation setup.
