---
title: "Single Document Extraction Test"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(knitr)
```

## Overview

This notebook tests the complete extraction workflow on a single document, validating JSON parsing and data structure.

## Load Packages and Data

```{r load-all}
library(dplyr)
library(jsonlite)

source("../R/gemini_extraction.R")

# Model configuration - change here to switch models
# Options: "gemini-2.5-flash-lite" (fast), "gemini-2.5-pro" (better quality)
GEMINI_MODEL <- "gemini-2.5-flash-lite"

data_dir <- "../data/fusarium"
sample_10 <- readRDS(file.path(data_dir, "sample_10_studies.rds"))
```

## Extract from Single Study

```{r single-extraction}
test_study <- sample_10[1, ]

tibble(
  Field = c("ID", "Title"),
  Value = c(test_study$id, substr(test_study$title, 1, 70))
) %>% kable()

result <- extract_fusarium_gemini(
  abstract = test_study$abstract_clean,
  title = test_study$title,
<<<<<<< HEAD
  keywords = safe_text(test_study$keywords_clean)
=======
  keywords = test_study$keywords_clean,
  model = GEMINI_MODEL
>>>>>>> origin/main
)
```

## Validate Output Structure

```{r validate-structure}
expected_fields <- c(
  "fusarium_species", "crop", "abiotic_factors", "mycotoxins",
  "observed_effects", "agronomic_practices", "modeling",
  "study_type", "summary"
)

tibble(
  Field = expected_fields,
  Present = expected_fields %in% names(result),
  Status = ifelse(expected_fields %in% names(result), "OK", "Missing")
) %>% kable()
```

## Extracted Information

```{r display-results}
tibble(
  Field = c(
    "Fusarium Species",
    "Crops",
    "Abiotic Factors",
    "Mycotoxins",
    "Observed Effects",
    "Agronomic Practices",
    "Modeling",
    "Study Type"
  ),
  Value = c(
    paste(result$fusarium_species, collapse = ", "),
    paste(result$crop, collapse = ", "),
    paste(result$abiotic_factors, collapse = ", "),
    paste(result$mycotoxins, collapse = ", "),
    paste(result$observed_effects, collapse = ", "),
    paste(result$agronomic_practices, collapse = ", "),
    as.character(result$modeling),
    paste(result$study_type, collapse = ", ")
  ),
  Count = c(
    length(result$fusarium_species),
    length(result$crop),
    length(result$abiotic_factors),
    length(result$mycotoxins),
    length(result$observed_effects),
    length(result$agronomic_practices),
    NA,
    length(result$study_type)
  )
) %>% kable()
```

## Summary

```{r show-summary}
tibble(
  Field = "Summary",
  Value = result$summary
) %>% kable()
```

## Test Error Handling

```{r test-errors}
error_tests <- tibble(
  Test = character(),
  Input = character(),
  Result = character()
)

# Test with empty abstract
result_empty <- tryCatch({
  extract_fusarium_gemini(abstract = "", title = "Test Title")
  "Completed"
}, error = function(e) {
  paste("Error:", conditionMessage(e))
})

error_tests <- bind_rows(error_tests, tibble(
  Test = "Empty abstract",
  Input = "Empty string",
  Result = result_empty
))

# Test with very short text
result_short <- tryCatch({
  extract_fusarium_gemini(abstract = "Short.", title = "")
  "Completed"
}, error = function(e) {
  paste("Error:", conditionMessage(e))
})

error_tests <- bind_rows(error_tests, tibble(
  Test = "Short text",
  Input = "Very short",
  Result = result_short
))

error_tests %>% kable()
```

## Validation Summary

```{r validation-summary}
all_present <- all(expected_fields %in% names(result))

tibble(
  Check = c(
    "Extraction completed",
    "JSON parsed",
    "All fields present",
    "Error handling works"
  ),
  Status = c("OK", "OK", ifelse(all_present, "OK", "Missing fields"), "OK")
) %>% kable()
```

## Next Steps

Proceed to `0330_handle_errors.Rmd` for systematic error handling.
