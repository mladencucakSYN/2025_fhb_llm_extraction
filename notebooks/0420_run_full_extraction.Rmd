---
title: "Run Full Extraction"
output: html_document
execute:
  eval: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, eval = FALSE)
library(knitr)
```

## Overview

This notebook runs the complete extraction pipeline on the full ecophysiology dataset.

**Note: This notebook is configured to not run automatically (eval=FALSE) to prevent accidental large API usage.**

## Load Packages

```{r load-all}
library(dplyr)

source("../R/gemini_extraction.R")
source("../R/retry_logic.R")
source("../R/batch_processor.R")
source("../R/cache_manager.R")

data_dir <- "../data/fusarium"
cache_dir <- "../data/cache"
```

## Load Dataset

```{r load-dataset}
ecophys_data <- readRDS(file.path(data_dir, "fusarium_ecophysiology_subset.rds"))
cached <- load_cached_extractions(cache_dir)
remaining <- get_uncached_docs(ecophys_data, id_col = "id", cache_dir = cache_dir)

tibble(
  Dataset = c("Full ecophysiology", "Already cached", "Remaining"),
  Studies = c(nrow(ecophys_data), nrow(cached), nrow(remaining))
) %>% kable()
```

## Configure Extraction

```{r configure-parameters}
CONFIG <- list(
  batch_size = 10,
  delay_seconds = 60,
  max_attempts = 3,
  checkpoint_every = 50
)

tibble(
  Parameter = c("Batch size", "Delay between batches", "Retry attempts", "Checkpoint frequency"),
  Value = c(
    paste(CONFIG$batch_size, "documents"),
    paste(CONFIG$delay_seconds, "seconds"),
    CONFIG$max_attempts,
    paste(CONFIG$checkpoint_every, "documents")
  )
) %>% kable()
```

## Time Estimate

```{r time-estimate}
est_batches <- ceiling(nrow(remaining) / CONFIG$batch_size)
est_time_min <- (est_batches * CONFIG$delay_seconds) / 60

tibble(
  Metric = c("Documents to process", "Number of batches", "Estimated time"),
  Value = c(
    nrow(remaining),
    est_batches,
    paste(round(est_time_min, 1), "minutes (~", round(est_time_min/60, 1), "hours)")
  )
) %>% kable()
```

## Run Extraction

```{r run-extraction, eval=FALSE}
# WARNING: This will make many API calls
# Only run when ready for full extraction

extract_one_study <- function(study_row) {
  result <- retry_with_backoff({
    extract_fusarium_gemini(
      abstract = study_row$abstract_clean,
      title = study_row$title,
      keywords = study_row$keywords_clean
    )
  }, max_attempts = CONFIG$max_attempts, base_delay = 2)

  if (!is.null(result)) {
    result$id <- study_row$id
    cache_extraction(study_row$id, result, cache_dir)
    as.data.frame(result, stringsAsFactors = FALSE)
  } else {
    NULL
  }
}

results_df <- process_with_checkpoints(
  docs = remaining,
  extract_fn = extract_one_study,
  id_col = "id",
  checkpoint_dir = cache_dir,
  checkpoint_every = CONFIG$checkpoint_every,
  batch_size = CONFIG$batch_size,
  delay_seconds = CONFIG$delay_seconds
)
```

## Load Results

```{r load-results}
all_results <- load_cached_extractions(cache_dir)

tibble(
  Metric = c("Total extractions", "Success rate"),
  Value = c(
    nrow(all_results),
    paste0(round(nrow(all_results) / nrow(ecophys_data) * 100, 1), "%")
  )
) %>% kable()

final_file <- file.path(data_dir, "fusarium_extracted_full.rds")
saveRDS(all_results, final_file)
```

## Extraction Summary

```{r summary}
if (exists("all_results") && nrow(all_results) > 0) {
  n_with_species <- sum(sapply(all_results$fusarium_species, length) > 0)
  n_with_crop <- sum(sapply(all_results$crop, length) > 0)
  n_with_factors <- sum(sapply(all_results$abiotic_factors, length) > 0)
  n_modeling <- sum(all_results$modeling, na.rm = TRUE)

  tibble(
    Metric = c(
      "Total processed",
      "With Fusarium species",
      "With crop info",
      "With abiotic factors",
      "Modeling studies"
    ),
    Count = c(
      nrow(all_results),
      n_with_species,
      n_with_crop,
      n_with_factors,
      n_modeling
    )
  ) %>% kable()
}
```

## Pre-run Checklist

```{r checklist}
tibble(
  Check = c(
    "API key valid",
    "API quota available",
    "Stable internet connection",
    "Time available for processing",
    "Monitoring plan"
  ),
  Status = c("[ ]", "[ ]", "[ ]", "[ ]", "[ ]")
) %>% kable(caption = "Complete before running full extraction")
```

## Next Steps

Proceed to `0430_extraction_diagnostics.Rmd` for diagnostics analysis.
