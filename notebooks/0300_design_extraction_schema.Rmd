---
title: "Design Extraction Schema"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(knitr)
```

## Overview

This notebook defines the structured data schema for extracting Fusarium research information. The schema guides prompt engineering and determines what information will be extracted from each study.

## Load Packages

```{r load-packages}
library(dplyr)
library(jsonlite)
```

## Define Extraction Fields

Based on exploratory analysis (notebook 0120) and research goals.

```{r extraction-schema}
extraction_schema <- list(
  fusarium_species = list(
    type = "array",
    description = "List of Fusarium species mentioned",
    examples = c("Fusarium graminearum", "F. culmorum", "F. avenaceum")
  ),
  crop = list(
    type = "array",
    description = "Cereal crops studied",
    examples = c("wheat", "barley", "maize", "oats")
  ),
  abiotic_factors = list(
    type = "array",
    description = "Environmental/abiotic factors investigated",
    examples = c("temperature", "moisture", "humidity", "drought", "rainfall")
  ),
  mycotoxins = list(
    type = "array",
    description = "Mycotoxins studied or measured",
    examples = c("DON", "deoxynivalenol", "zearalenone", "nivalenol")
  ),
  observed_effects = list(
    type = "array",
    description = "Effects on crop or disease observed",
    examples = c("yield loss", "disease severity", "toxin production")
  ),
  agronomic_practices = list(
    type = "array",
    description = "Management or agronomic practices mentioned",
    examples = c("fungicide application", "crop rotation", "resistant cultivars")
  ),
  modeling = list(
    type = "boolean",
    description = "Whether study involves predictive modeling or simulation"
  ),
  study_type = list(
    type = "array",
    description = "Type of study conducted",
    examples = c("field", "greenhouse", "laboratory", "modeling", "meta-analysis")
  ),
  summary = list(
    type = "string",
    description = "Brief 1-2 sentence summary of main findings"
  )
)

tibble(
  Field = names(extraction_schema),
  Type = sapply(extraction_schema, function(x) x$type),
  Description = sapply(extraction_schema, function(x) x$description)
) %>% kable()
```

## JSON Template

Define the exact JSON structure that LLM should return.

```{r json-template}
json_template <- list(
  fusarium_species = list(),
  crop = list(),
  abiotic_factors = list(),
  mycotoxins = list(),
  observed_effects = list(),
  agronomic_practices = list(),
  modeling = FALSE,
  study_type = list(),
  summary = ""
)

toJSON(json_template, pretty = TRUE, auto_unbox = TRUE)
```

## Save Schema Documentation

```{r save-schema}
data_dir <- "../data/fusarium"

schema_doc <- list(
  version = "1.0",
  date = as.character(Sys.Date()),
  fields = extraction_schema,
  json_template = json_template
)

schema_file <- file.path(data_dir, "extraction_schema.json")
write_json(schema_doc, schema_file, pretty = TRUE, auto_unbox = TRUE)

tibble(
  Output = "Extraction schema",
  Path = schema_file,
  Fields = length(extraction_schema)
) %>% kable()
```

## Summary

```{r summary}
tibble(
  Field = names(extraction_schema),
  Type = sapply(extraction_schema, function(x) x$type)
) %>% kable(caption = "Extraction Schema Fields")
```

## Next Steps

Proceed to `0310_develop_prompts.Rmd` to develop extraction prompts.
