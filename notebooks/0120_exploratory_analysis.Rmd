---
title: "Exploratory Analysis of Fusarium Dataset"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(knitr)
```

## Overview

This notebook performs exploratory analysis of the preprocessed Fusarium dataset to understand content patterns, identify key topics, and inform extraction schema design.

## Load Packages

```{r load-packages}
library(dplyr)
library(stringr)
library(ggplot2)
library(tidyr)
library(tidytext)
```

## Load Data

```{r load-data}
data_dir <- "../data/fusarium"
data_file <- file.path(data_dir, "fusarium_studies_preprocessed.rds")

fusarium_data <- readRDS(data_file)
valid_data <- fusarium_data %>% filter(!exclude_from_extraction)

tibble(
  Dataset = c("Total studies", "Valid for analysis"),
  Count = c(nrow(fusarium_data), nrow(valid_data))
) %>% kable()
```

## Temporal Trends

```{r temporal-trends, fig.width=10, fig.height=5}
temporal_summary <- valid_data %>%
<<<<<<< HEAD
  count(pub_year, sort = TRUE) %>%
  mutate(
    cumulative = cumsum(n),
    pct_total = cumulative / sum(n) * 100
  )

print(head(temporal_summary, 10))

# Plot publication trend
ggplot(temporal_summary, aes(x = pub_year, y = n)) +
  geom_line(color = "steelblue", size = 1) +
=======
  count(year, name = "n_studies") %>%
  arrange(year) %>%
  mutate(cumulative = cumsum(n_studies))

ggplot(temporal_summary, aes(x = year, y = n_studies)) +
  geom_line(color = "steelblue", linewidth = 1) +
>>>>>>> origin/main
  geom_point(color = "steelblue", size = 2) +
  geom_smooth(method = "loess", se = TRUE, color = "red", linetype = "dashed") +
  labs(
    title = "Publication Trends Over Time",
    x = "Year",
    y = "Number of Publications"
  ) +
  theme_minimal()

temporal_summary %>%
  summarise(
    `Year range` = paste(min(year), "-", max(year)),
    `Peak year` = year[which.max(n_studies)],
    `Peak publications` = max(n_studies),
    `Total publications` = sum(n_studies)
  ) %>% kable()
```

## Keyword Analysis

```{r keyword-analysis, fig.width=10, fig.height=6}
keywords_df <- valid_data %>%
  filter(!is.na(keywords_clean), nchar(keywords_clean) > 0) %>%
  select(id, keywords_clean) %>%
  mutate(keywords_list = str_split(keywords_clean, "[,;]")) %>%
  unnest(keywords_list) %>%
  mutate(keyword = str_trim(tolower(keywords_list))) %>%
  filter(nchar(keyword) > 2) %>%
  count(keyword, sort = TRUE)

tibble(
  Metric = c("Studies with keywords", "Unique keywords"),
  Value = c(
    sum(!is.na(valid_data$keywords_clean) & nchar(valid_data$keywords_clean) > 0),
    nrow(keywords_df)
  )
) %>% kable()

keywords_df %>%
  head(20) %>%
  ggplot(aes(x = reorder(keyword, n), y = n)) +
  geom_col(fill = "darkgreen", alpha = 0.7) +
  coord_flip() +
  labs(title = "Top 20 Keywords", x = "Keyword", y = "Frequency") +
  theme_minimal()

keywords_df %>% head(20) %>% kable()
```

## Term Frequency in Abstracts

```{r term-frequency, fig.width=10, fig.height=6}
abstract_words <- valid_data %>%
  select(id, abstract_clean) %>%
  unnest_tokens(word, abstract_clean) %>%
  anti_join(stop_words, by = "word") %>%
  filter(nchar(word) > 3, !str_detect(word, "^\\d+$"))

word_freq <- abstract_words %>% count(word, sort = TRUE)

word_freq %>%
  head(30) %>%
  ggplot(aes(x = reorder(word, n), y = n)) +
  geom_col(fill = "coral", alpha = 0.7) +
  coord_flip() +
  labs(title = "Top 30 Terms in Abstracts", x = "Term", y = "Frequency") +
  theme_minimal()

word_freq %>% head(30) %>% kable()
```

## Fusarium Species Analysis

<<<<<<< HEAD
## Fusarium Species Mentions

Identify which Fusarium species are most frequently studied.

```{r fusarium-species}
cat("\nFusarium Species Analysis:\n")
cat(rep("-", 50), "\n", sep = "")

# Common Fusarium species patterns
species_patterns <- c(
  "F\\. graminearum|Fusarium graminearum",
  "F\\. culmorum|Fusarium culmorum",
  "F\\. avenaceum|Fusarium avenaceum",
  "F\\. equiseti|Fusarium equiseti",
  "F\\. temperatum|Fusarium temperatum",
  "F\\. poae|Fusarium poae",
  "F\\. sporotrichioides|Fusarium sporotrichioides",
  "F\\. verticillioides|Fusarium verticillioides",
  "F\\. proliferatum|Fusarium proliferatum"
)

species_names <- c(
  "F. graminearum",
  "F. culmorum",
  "F. avenaceum",
  "F. equiseti",
  "F. temperatum",
  "F. poae",
  "F. sporotrichioides",
  "F. verticillioides",
  "F. proliferatum"
=======
```{r fusarium-species, fig.width=10, fig.height=5}
species_patterns <- list(
  "F. graminearum" = "F\\. graminearum|Fusarium graminearum",
  "F. culmorum" = "F\\. culmorum|Fusarium culmorum",
  "F. avenaceum" = "F\\. avenaceum|Fusarium avenaceum",
  "F. poae" = "F\\. poae|Fusarium poae",
  "F. sporotrichioides" = "F\\. sporotrichioides|Fusarium sporotrichioides",
  "F. verticillioides" = "F\\. verticillioides|Fusarium verticillioides",
  "F. proliferatum" = "F\\. proliferatum|Fusarium proliferatum"
>>>>>>> origin/main
)

species_counts <- tibble(
  Species = names(species_patterns),
  Count = sapply(species_patterns, function(p) {
    sum(str_detect(valid_data$combined_text, regex(p, ignore_case = TRUE)))
  }),
  Percentage = round(Count / nrow(valid_data) * 100, 1)
) %>% arrange(desc(Count))

ggplot(species_counts, aes(x = reorder(Species, Count), y = Count)) +
  geom_col(fill = "purple", alpha = 0.7) +
  geom_text(aes(label = paste0(Count, " (", Percentage, "%)")), hjust = -0.1, size = 3) +
  coord_flip() +
  labs(title = "Fusarium Species Mentions", x = "Species", y = "Studies") +
  theme_minimal() +
  expand_limits(y = max(species_counts$Count) * 1.2)

species_counts %>% kable()
```

## Crop Host Analysis

```{r crop-analysis, fig.width=10, fig.height=5}
crop_patterns <- list(
  "Wheat" = "\\bwheat\\b",
  "Barley" = "\\bbarley\\b",
  "Maize/Corn" = "\\bmaize\\b|\\bcorn\\b",
  "Oat" = "\\boats?\\b",
  "Rye" = "\\brye\\b",
  "Triticale" = "\\btriticale\\b",
  "Rice" = "\\brice\\b"
)

crop_counts <- tibble(
  Crop = names(crop_patterns),
  Count = sapply(crop_patterns, function(p) {
    sum(str_detect(valid_data$combined_text, regex(p, ignore_case = TRUE)))
  }),
  Percentage = round(Count / nrow(valid_data) * 100, 1)
) %>% arrange(desc(Count))

ggplot(crop_counts, aes(x = reorder(Crop, Count), y = Count)) +
  geom_col(fill = "goldenrod", alpha = 0.7) +
  geom_text(aes(label = paste0(Count, " (", Percentage, "%)")), hjust = -0.1, size = 3) +
  coord_flip() +
  labs(title = "Crop Mentions", x = "Crop", y = "Studies") +
  theme_minimal() +
  expand_limits(y = max(crop_counts$Count) * 1.2)

crop_counts %>% kable()
```

## Climate/Environmental Factors

<<<<<<< HEAD
## Climate-Related Terms

Analyze mentions of climate and environmental factors.

```{r climate-terms}
cat("\nClimate/Environmental Factor Analysis:\n")
cat(rep("-", 50), "\n", sep = "")

climate_patterns <- c(
  "temperature" = "\\btemperature",
  "moisture" = "\\bmoisture",
  "humidity" = "\\bhumidity",
  "rainfall|precipitation" = "\\brainfall|\\bprecipitation",
  "drought" = "\\bdrought",
  "climate change" = "\\bclimate change",
  "water stress" = "\\bwater stress",
  "heat stress" = "\\bheat stress",
  "carbon dioxide|CO2" = "\\bcarbon dioxide|\\bCO2",
  "light|UV" = "\\blight|\\bUV"
=======
```{r climate-terms, fig.width=10, fig.height=5}
climate_patterns <- list(
  "Temperature" = "\\btemperature",
  "Moisture" = "\\bmoisture",
  "Humidity" = "\\bhumidity",
  "Rainfall/Precipitation" = "\\brainfall|\\bprecipitation",
  "Drought" = "\\bdrought",
  "Climate change" = "\\bclimate change",
  "Water stress" = "\\bwater stress",
  "Heat stress" = "\\bheat stress"
>>>>>>> origin/main
)

climate_counts <- tibble(
  Factor = names(climate_patterns),
  Count = sapply(climate_patterns, function(p) {
    sum(str_detect(valid_data$combined_text, regex(p, ignore_case = TRUE)))
  }),
  Percentage = round(Count / nrow(valid_data) * 100, 1)
) %>% arrange(desc(Count))

ggplot(climate_counts, aes(x = reorder(Factor, Count), y = Count)) +
  geom_col(fill = "skyblue", alpha = 0.7) +
  geom_text(aes(label = paste0(Count, " (", Percentage, "%)")), hjust = -0.1, size = 3) +
  coord_flip() +
  labs(title = "Climate/Environmental Factors", x = "Factor", y = "Studies") +
  theme_minimal() +
  expand_limits(y = max(climate_counts$Count) * 1.2)

climate_counts %>% kable()
```

## Mycotoxin Analysis

```{r mycotoxin-analysis, fig.width=10, fig.height=5}
toxin_patterns <- list(
  "DON/Deoxynivalenol" = "\\bDON\\b|\\bdeoxynivalenol",
  "Zearalenone/ZEN" = "\\bzearalenone|\\bZEN\\b",
  "T-2 toxin" = "\\bT-2\\b",
<<<<<<< HEAD
  "nivalenol|NIV" = "\\bnivalenol|\\bNIV\\b",
  "NX toxins|NX-2|NX-3" = "\\bNX toxins|bNX-2|bNX-3",
  "fumonisin" = "\\bfumonisin",
  "monoacetoxyscripenol|MAS" = "\\bmonoacetoxyscripenol|bMAS",
  "enniatin|ENN" = "\\benniatin|bENN",
  "beuavericin|BEA" = "bbeuavericin|bBEA",
  "moniliformin|MON" = "bmoniliformin|bMON",
  "fusaproliferin|FUS" = "bfusaproliferin|bFUS"
=======
  "Nivalenol/NIV" = "\\bnivalenol|\\bNIV\\b",
  "Fumonisin" = "\\bfumonisin"
>>>>>>> origin/main
)

toxin_counts <- tibble(
  Mycotoxin = names(toxin_patterns),
  Count = sapply(toxin_patterns, function(p) {
    sum(str_detect(valid_data$combined_text, regex(p, ignore_case = TRUE)))
  }),
  Percentage = round(Count / nrow(valid_data) * 100, 1)
) %>% arrange(desc(Count))

ggplot(toxin_counts, aes(x = reorder(Mycotoxin, Count), y = Count)) +
  geom_col(fill = "darkred", alpha = 0.7) +
  geom_text(aes(label = paste0(Count, " (", Percentage, "%)")), hjust = -0.1, size = 3) +
  coord_flip() +
  labs(title = "Mycotoxin Mentions", x = "Mycotoxin", y = "Studies") +
  theme_minimal() +
  expand_limits(y = max(toxin_counts$Count) * 1.2)

toxin_counts %>% kable()
```

## Study Type Classification

```{r study-types, fig.width=10, fig.height=5}
study_type_patterns <- list(
  "Field study" = "\\bfield\\b|\\bfield trial|\\bfield experiment",
  "Greenhouse" = "\\bgreenhouse|\\bglasshouse|\\bcontrolled environment",
  "Laboratory" = "\\blaboratory|\\bin vitro|\\bpetri",
  "Modeling" = "\\bmodel|\\bsimulation|\\bpredict",
  "Meta-analysis" = "\\bmeta-analysis|\\bsystematic review"
)

study_type_counts <- tibble(
  `Study Type` = names(study_type_patterns),
  Count = sapply(study_type_patterns, function(p) {
    sum(str_detect(valid_data$combined_text, regex(p, ignore_case = TRUE)))
  }),
  Percentage = round(Count / nrow(valid_data) * 100, 1)
) %>% arrange(desc(Count))

ggplot(study_type_counts, aes(x = reorder(`Study Type`, Count), y = Count)) +
  geom_col(fill = "forestgreen", alpha = 0.7) +
  geom_text(aes(label = paste0(Count, " (", Percentage, "%)")), hjust = -0.1, size = 3) +
  coord_flip() +
  labs(
    title = "Study Types",
    subtitle = "Studies may belong to multiple categories",
    x = "Study Type", y = "Studies"
  ) +
  theme_minimal() +
  expand_limits(y = max(study_type_counts$Count) * 1.2)

study_type_counts %>% kable()
```

## Co-occurrence Analysis

```{r cooccurrence}
concept_data <- valid_data %>%
  mutate(
    has_temperature = str_detect(combined_text, regex("temperature", ignore_case = TRUE)),
    has_moisture = str_detect(combined_text, regex("moisture|humidity", ignore_case = TRUE)),
    has_drought = str_detect(combined_text, regex("drought|water stress", ignore_case = TRUE)),
    has_don = str_detect(combined_text, regex("DON|deoxynivalenol", ignore_case = TRUE)),
    has_modeling = str_detect(combined_text, regex("model|predict", ignore_case = TRUE)),
    has_wheat = str_detect(combined_text, regex("wheat", ignore_case = TRUE))
  )

cooccurrence <- tibble(
  `Concept Pair` = c(
    "Temperature + Moisture",
    "Temperature + DON",
    "Moisture + DON",
    "Temperature + Modeling",
    "Wheat + DON",
    "Wheat + Temperature"
  ),
  `Co-occurrences` = c(
    sum(concept_data$has_temperature & concept_data$has_moisture),
    sum(concept_data$has_temperature & concept_data$has_don),
    sum(concept_data$has_moisture & concept_data$has_don),
    sum(concept_data$has_temperature & concept_data$has_modeling),
    sum(concept_data$has_wheat & concept_data$has_don),
    sum(concept_data$has_wheat & concept_data$has_temperature)
  )
) %>%
  mutate(`% of Dataset` = round(`Co-occurrences` / nrow(valid_data) * 100, 1)) %>%
  arrange(desc(`Co-occurrences`))

cooccurrence %>% kable()
```

## Geographic Distribution

```{r geographic, fig.width=10, fig.height=6}
if ("countries" %in% names(valid_data)) {
  country_data <- valid_data %>%
    filter(!is.na(countries), nchar(countries) > 0) %>%
    select(id, countries) %>%
    mutate(country_list = str_split(countries, "; ")) %>%
    unnest(country_list) %>%
    mutate(country = str_trim(str_remove(country_list, "\\.$"))) %>%
    filter(nchar(country) > 0)

  country_counts <- country_data %>% count(country, sort = TRUE)

  tibble(
    Metric = c("Studies with country data", "Unique countries"),
    Value = c(
      sum(!is.na(valid_data$countries) & nchar(valid_data$countries) > 0),
      nrow(country_counts)
    )
  ) %>% kable()

  country_counts %>%
    head(15) %>%
    ggplot(aes(x = reorder(country, n), y = n)) +
    geom_col(fill = "steelblue", alpha = 0.7) +
    geom_text(aes(label = n), hjust = -0.2, size = 3) +
    coord_flip() +
    labs(title = "Top 15 Countries by Research Output", x = "Country", y = "Studies") +
    theme_minimal()

  country_counts %>% head(15) %>% kable()
}
```

## MeSH Term Analysis

```{r mesh-analysis, fig.width=10, fig.height=6}
if ("mesh_terms" %in% names(valid_data)) {
  mesh_data <- valid_data %>%
    filter(!is.na(mesh_terms), nchar(mesh_terms) > 0) %>%
    select(id, mesh_terms) %>%
    mutate(mesh_list = str_split(mesh_terms, "; ")) %>%
    unnest(mesh_list) %>%
    mutate(mesh = str_trim(mesh_list)) %>%
    filter(nchar(mesh) > 0)

  mesh_counts <- mesh_data %>% count(mesh, sort = TRUE)

  tibble(
    Metric = c("Studies with MeSH terms", "Unique MeSH terms"),
    Value = c(
      sum(!is.na(valid_data$mesh_terms) & nchar(valid_data$mesh_terms) > 0),
      nrow(mesh_counts)
    )
  ) %>% kable()

  mesh_counts %>%
    head(20) %>%
    ggplot(aes(x = reorder(mesh, n), y = n)) +
    geom_col(fill = "darkgreen", alpha = 0.7) +
    coord_flip() +
    labs(title = "Top 20 MeSH Terms", x = "MeSH Term", y = "Frequency") +
    theme_minimal()

  mesh_counts %>% head(20) %>% kable()
}
```

## Dataset Summary

```{r dataset-summary}
# Identify top items from each category
top_species <- species_counts %>% filter(Count == max(Count)) %>% pull(Species)
top_crop <- crop_counts %>% filter(Count == max(Count)) %>% pull(Crop)
top_climate <- climate_counts %>% filter(Count == max(Count)) %>% pull(Factor)
top_toxin <- toxin_counts %>% filter(Count == max(Count)) %>% pull(Mycotoxin)
top_study_type <- study_type_counts %>% filter(Count == max(Count)) %>% pull(`Study Type`)

tibble(
  Category = c(
    "Most studied species",
    "Most studied crop",
    "Most mentioned climate factor",
    "Most mentioned mycotoxin",
    "Most common study type",
    "Total valid studies"
  ),
  Value = c(
    top_species[1],
    top_crop[1],
    top_climate[1],
    top_toxin[1],
    top_study_type[1],
    nrow(valid_data)
  )
) %>% kable()
```

## Recommended Extraction Fields

Based on the exploratory analysis, the following extraction schema is recommended:

```{r extraction-schema}
tibble(
  Field = c(
    "fusarium_species",
    "crop",
    "abiotic_factors",
    "mycotoxins",
    "observed_effects",
    "agronomic_practices",
    "modeling",
    "study_type",
    "summary"
  ),
  Type = c(
    "array",
    "array",
    "array",
    "array",
    "array",
    "array",
    "boolean",
    "array",
    "text"
  ),
  `Common Values` = c(
    paste(species_counts$Species[1:3], collapse = ", "),
    paste(crop_counts$Crop[1:3], collapse = ", "),
    paste(climate_counts$Factor[1:3], collapse = ", "),
    paste(toxin_counts$Mycotoxin[1:3], collapse = ", "),
    "yield loss, disease severity, toxin production",
    "fungicide, rotation, tillage, resistant cultivars",
    "TRUE/FALSE",
    paste(study_type_counts$`Study Type`[1:3], collapse = ", "),
    "1-2 sentence summary"
  )
) %>% kable()
```

## Next Steps

Proceed to `0200_lda_first_pass.Rmd` for topic modeling analysis.
