---
title: "Develop Extraction Prompts"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(knitr)
```

## Overview

This notebook develops and tests extraction prompts for Fusarium research data. Effective prompts are critical for accurate LLM extraction.

## Load Packages and Data

```{r load-packages}
library(dplyr)
library(jsonlite)

source("../R/gemini_extraction.R")

data_dir <- "../data/fusarium"
```

```{r load-sample}
sample_10 <- readRDS(file.path(data_dir, "sample_10_studies.rds"))

tibble(
  Dataset = "Test sample",
  Studies = nrow(sample_10)
) %>% kable()
```

## Build Extraction Prompt

```{r build-prompt}
build_extraction_prompt <- function(title, abstract, keywords = "") {
  title <- if (is.null(title) || is.na(title)) "" else as.character(title)
  abstract <- if (is.null(abstract) || is.na(abstract)) "" else as.character(abstract)
  keywords <- if (is.null(keywords) || is.na(keywords)) "" else as.character(keywords)

  full_text <- paste(
    if (nchar(title) > 0) paste("Title:", title) else "",
    if (nchar(abstract) > 0) paste("Abstract:", abstract) else "",
    if (nchar(keywords) > 0) paste("Keywords:", keywords) else "",
    sep = "\n\n"
  )

  prompt <- sprintf('
Extract structured information about Fusarium species research on cereal crops.

TEXT TO ANALYZE:
%s

EXTRACT THE FOLLOWING INFORMATION:

1. fusarium_species: Array of Fusarium species names mentioned
2. crop: Array of cereal crops studied
3. abiotic_factors: Array of environmental factors investigated
4. mycotoxins: Array of mycotoxins studied
5. observed_effects: Array of effects on crop or disease
6. agronomic_practices: Array of management practices mentioned
7. modeling: Boolean indicating if study involves predictive modeling
8. study_type: Array of study methodology types
9. summary: Brief 1-2 sentence summary of main findings

RETURN ONLY VALID JSON IN THIS EXACT FORMAT:
{
  "fusarium_species": [],
  "crop": [],
  "abiotic_factors": [],
  "mycotoxins": [],
  "observed_effects": [],
  "agronomic_practices": [],
  "modeling": false,
  "study_type": [],
  "summary": ""
}

IMPORTANT:
- Return ONLY the JSON, no other text
- Use empty arrays [] for missing information
- Use lowercase for crop names and factors
', full_text)

  prompt
}
```

## Test Prompt on Single Study

```{r test-single}
test_study <- sample_10[1, ]

tibble(
  Field = c("ID", "Title"),
  Value = c(test_study$id, substr(test_study$title, 1, 60))
) %>% kable()

prompt <- build_extraction_prompt(
  title = test_study$title,
  abstract = test_study$abstract_clean,
  keywords = test_study$keywords_clean
)

response <- simple_gemini(prompt)

parsed <- tryCatch({
  fromJSON(response)
}, error = function(e) {
  NULL
})

if (!is.null(parsed)) {
  tibble(
    Field = names(parsed),
    Value = sapply(parsed, function(x) {
      if (is.list(x)) paste(unlist(x), collapse = ", ")
      else as.character(x)
    })
  ) %>% kable()
}
```

## Test on Multiple Studies

```{r test-multiple}
results <- list()
test_results <- tibble(
  Study = integer(),
  Status = character(),
  Species = integer(),
  Crops = integer()
)

for (i in 1:min(5, nrow(sample_10))) {
  prompt <- build_extraction_prompt(
    title = sample_10$title[i],
    abstract = sample_10$abstract_clean[i],
    keywords = sample_10$keywords_clean[i]
  )

  result <- tryCatch({
    response <- simple_gemini(prompt)
    parsed <- fromJSON(response)
    parsed$id <- sample_10$id[i]
    results[[i]] <- parsed

    test_results <- bind_rows(test_results, tibble(
      Study = i,
      Status = "Success",
      Species = length(parsed$fusarium_species),
      Crops = length(parsed$crop)
    ))

    parsed
  }, error = function(e) {
    test_results <<- bind_rows(test_results, tibble(
      Study = i,
      Status = "Error",
      Species = NA_integer_,
      Crops = NA_integer_
    ))
    NULL
  })

  Sys.sleep(2)
}

test_results %>% kable()
```

## Extraction Analysis

```{r analyze-results}
if (length(results) > 0) {
  analysis <- tibble(
    Study = seq_along(results),
    Species = sapply(results, function(r) length(r$fusarium_species)),
    Crops = sapply(results, function(r) length(r$crop)),
    `Abiotic Factors` = sapply(results, function(r) length(r$abiotic_factors)),
    Mycotoxins = sapply(results, function(r) length(r$mycotoxins)),
    Modeling = sapply(results, function(r) r$modeling)
  )

  analysis %>% kable()
}
```

## Save Prompt Documentation

```{r save-prompt}
prompt_doc <- list(
  version = "1.0",
  date = as.character(Sys.Date()),
  notes = "Prompt includes detailed instructions for each field and JSON output format"
)

prompt_file <- file.path(data_dir, "extraction_prompt_v1.json")
write_json(prompt_doc, prompt_file, pretty = TRUE)

tibble(
  Output = "Prompt documentation",
  Path = prompt_file
) %>% kable()
```

## Summary

```{r summary}
tibble(
  Metric = c("Studies tested", "Successful extractions", "Success rate"),
  Value = c(
    nrow(test_results),
    sum(test_results$Status == "Success"),
    paste0(round(mean(test_results$Status == "Success") * 100), "%")
  )
) %>% kable()
```

## Next Steps

Proceed to `0320_single_extraction_test.Rmd` to refine extraction testing.
