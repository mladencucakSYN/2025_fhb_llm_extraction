---
title: "Test Gemini API Connection"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = TRUE, warning = TRUE)
library(knitr)
```

## Testing Gemini API

This notebook verifies that the Google Gemini API is properly configured and working.

## Load Environment

```{r load-env}
if (file.exists(".env")) {
  readRenviron(".env")
}

api_key_set <- nchar(Sys.getenv("GOOGLE_API_KEY")) > 0

tibble::tibble(
  Check = c(".env file", "API key"),
  Status = c(
    ifelse(file.exists(".env"), "Found", "Not found"),
    ifelse(api_key_set, "Configured", "Not set")
  )
) %>% kable()

if (!api_key_set) {
  stop("GOOGLE_API_KEY not set. See 0000_setup_environment.Rmd")
}
```

## Load Packages

```{r load-packages}
if (!requireNamespace("ellmer", quietly = TRUE)) {
  install.packages("ellmer", repos = "https://cloud.r-project.org")
}

library(ellmer)
source("../R/gemini_extraction.R")
```

## Test 1: Simple Math Question

```{r test-math}
question <- "What is 2+2? Give a brief answer in one sentence."
response <- simple_gemini(question)

tibble::tibble(
  Test = "Simple Math",
  Question = question,
  Response = response
) %>% kable()
```

## Test 2: Text Understanding

```{r test-understanding}
text <- "The quick brown fox jumps over the lazy dog."
question <- sprintf(
  "What animal jumped in this sentence: '%s'? Answer in one word.", text
)
response <- simple_gemini(question)

tibble::tibble(
  Test = "Text Understanding",
  Input = text,
  Response = response
) %>% kable()
```

## Test 3: JSON Output

```{r test-json}
prompt <- '
Return this information as JSON:
- name: "Alice"
- age: 30
- city: "New York"

Return ONLY the JSON, no other text.
'

response <- simple_gemini(prompt)

parsed <- tryCatch({
  jsonlite::fromJSON(response)
}, error = function(e) NULL)

tibble::tibble(
  Test = "JSON Output",
  `Raw Response` = substr(response, 1, 100),
  `Parse Success` = !is.null(parsed)
) %>% kable()

if (!is.null(parsed)) {
  as.data.frame(parsed) %>% kable(caption = "Parsed JSON")
}
```

## Test 4: Information Extraction

```{r test-extraction}
sample_text <- paste(
  "John Smith works at Acme Corp as a Data Scientist.",
  "His email is john.smith@acme.com and phone is (555) 123-4567."
)

extraction_prompt <- sprintf('
Extract the following from this text and return as JSON:
- name, company, job_title, email, phone

Text: %s

Return ONLY valid JSON.
', sample_text)

response <- simple_gemini(extraction_prompt)

extracted <- tryCatch({
  jsonlite::fromJSON(response)
}, error = function(e) NULL)

if (!is.null(extracted)) {
  as.data.frame(extracted) %>% kable(caption = "Extracted Information")
}
```

## Test 5: Error Handling

```{r test-error-handling}
# Test with empty message
empty_result <- tryCatch({
  simple_gemini("")
  "Handled"
}, error = function(e) "Error")

# Test with long message
long_message <- paste(rep("test ", 100), collapse = "")
long_result <- tryCatch({
  simple_gemini(paste("Summarize in 5 words:", long_message))
  "Handled"
}, error = function(e) "Error")

tibble::tibble(
  Test = c("Empty message", "Long message"),
  Result = c(empty_result, long_result)
) %>% kable()
```

## Test Summary

```{r summary}
# Compute test results from actual variables
test_results <- tibble::tibble(
  Test = c(
    "API Connection",
    "Basic Chat (Math)",
    "Text Understanding",
    "JSON Output",
    "Information Extraction",
    "Error Handling"
  ),
  Status = c(
    ifelse(api_key_set, "Configured", "Failed"),
    ifelse(exists("response") && nchar(response) > 0, "Working", "Failed"),
    ifelse(exists("response") && nchar(response) > 0, "Working", "Failed"),
    ifelse(exists("parsed") && !is.null(parsed), "Working", "Needs review"),
    ifelse(exists("extracted") && !is.null(extracted), "Working", "Needs review"),
    ifelse(empty_result == "Handled" || long_result == "Handled", "Tested", "Failed")
  )
)

test_results %>% kable()
```

## API Configuration

```{r api-details}
tibble::tibble(
  Setting = c("Model", "Package", "API Key Source"),
  Value = c("gemini-2.0-flash-exp", "ellmer", "GOOGLE_API_KEY env var")
) %>% kable()
```

## Troubleshooting

Common issues:

| Issue | Solution |
|-------|----------|
| API Key Errors | Check `.env` file exists with `GOOGLE_API_KEY=your_key` |
| Network Errors | Check internet connectivity, firewall/proxy settings |
| Rate Limits (429) | Wait 60 seconds, use retry logic |
| JSON Parse Errors | Use explicit prompts: "Return ONLY valid JSON" |

## Next Steps

1. Gemini API is working
2. Learn extraction concepts in `0020_toy_example_extraction.Rmd`
3. Error handling in `0030_error_handling_basics.Rmd`
