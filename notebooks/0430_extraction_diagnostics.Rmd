---
title: "Extraction Diagnostics"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(knitr)
```

## Overview

This notebook analyzes extraction results to identify errors, assess quality, and determine which documents need retry.

## Load Packages and Data

```{r load-packages}
library(dplyr)
library(ggplot2)
library(tidyr)

data_dir <- "../data/fusarium"
cache_dir <- "../data/cache"
```

```{r load-results}
all_results <- readRDS(file.path(data_dir, "batch_extraction_results_demo.rds"))

tibble(
  Dataset = "Extraction results",
  Records = nrow(all_results)
) %>% kable()
```

## Field Completion Analysis

```{r field-completion, fig.width=10, fig.height=5}
completion_stats <- all_results %>%
  summarise(
    total = n(),
    has_species = sum(sapply(fusarium_species, function(x) length(x) > 0)),
    has_crop = sum(sapply(crop, function(x) length(x) > 0)),
    has_abiotic = sum(sapply(abiotic_factors, function(x) length(x) > 0)),
    has_mycotoxins = sum(sapply(mycotoxins, function(x) length(x) > 0)),
    has_practices = sum(sapply(agronomic_practices, function(x) length(x) > 0)),
    is_modeling = sum(modeling, na.rm = TRUE),
    has_summary = sum(nchar(summary) > 10)
  ) %>%
  pivot_longer(-total, names_to = "field", values_to = "count") %>%
  mutate(percentage = round(count / total * 100, 1))

ggplot(completion_stats, aes(x = reorder(field, -percentage), y = percentage)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = paste0(percentage, "%")), vjust = -0.5) +
  labs(
    title = "Field Completion Rates",
    x = "Field",
    y = "Percentage of Documents"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

completion_stats %>% kable()
```

## Empty Extractions

```{r empty-extractions}
all_results <- all_results %>%
  mutate(
    is_empty = sapply(fusarium_species, length) == 0 &
               sapply(crop, length) == 0 &
               sapply(abiotic_factors, length) == 0
  )

empty_count <- sum(all_results$is_empty)

tibble(
  Metric = c("Empty extractions", "Percentage", "Status"),
  Value = c(
    empty_count,
    paste0(round(empty_count / nrow(all_results) * 100, 1), "%"),
    ifelse(empty_count == 0, "All OK", "Review needed")
  )
) %>% kable()
```

## Species Distribution

```{r species-distribution, fig.width=10, fig.height=5}
species_flat <- all_results %>%
  select(id, fusarium_species) %>%
  tidyr::unnest(fusarium_species) %>%
  mutate(fusarium_species = tolower(fusarium_species))

if (nrow(species_flat) > 0) {
  species_counts <- species_flat %>%
    count(fusarium_species, sort = TRUE) %>%
    head(10)

  ggplot(species_counts, aes(x = reorder(fusarium_species, n), y = n)) +
    geom_col(fill = "purple", alpha = 0.7) +
    geom_text(aes(label = n), hjust = -0.2) +
    coord_flip() +
    labs(
      title = "Top Fusarium Species Extracted",
      x = "Species",
      y = "Count"
    ) +
    theme_minimal()

  species_counts %>% kable()
}
```

## Crop Distribution

```{r crop-distribution}
crop_flat <- all_results %>%
  select(id, crop) %>%
  tidyr::unnest(crop) %>%
  mutate(crop = tolower(crop))

if (nrow(crop_flat) > 0) {
  crop_counts <- crop_flat %>%
    count(crop, sort = TRUE)

  crop_counts %>% kable()
}
```

## Diagnostic Summary

```{r summary}
tibble(
  Metric = c(
    "Total extractions",
    "Empty extractions",
    "Quality rate",
    "Unique species",
    "Unique crops"
  ),
  Value = c(
    nrow(all_results),
    empty_count,
    paste0(round((1 - empty_count/nrow(all_results)) * 100, 1), "%"),
    ifelse(nrow(species_flat) > 0, n_distinct(species_flat$fusarium_species), 0),
    ifelse(nrow(crop_flat) > 0, n_distinct(crop_flat$crop), 0)
  )
) %>% kable()
```

## Next Steps

Proceed to `0500_quality_assessment.Rmd` for quality assessment.
