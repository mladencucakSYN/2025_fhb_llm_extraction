---
title: "LDA Topic Modeling - First Pass"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(knitr)
```

## Overview

This notebook applies Latent Dirichlet Allocation (LDA) to identify major themes in the Fusarium literature. Topic modeling helps reduce a large corpus to interpretable themes before targeted extraction.

## Load Packages

```{r load-packages}
library(dplyr)
library(stringr)
library(ggplot2)
library(tidytext)
library(topicmodels)
library(tidyr)
```

## Load Data

```{r load-data}
data_dir <- "../data/fusarium"
fusarium_data <- readRDS(file.path(data_dir, "fusarium_studies_extraction_ready.rds"))

tibble(
  Metric = c("Studies loaded"),
  Value = nrow(fusarium_data)
) %>% kable()
```

## Create Document-Term Matrix

```{r create-dtm}
abstract_tokens <- fusarium_data %>%
  select(id, abstract_clean) %>%
  unnest_tokens(word, abstract_clean) %>%
  anti_join(stop_words, by = "word") %>%
  filter(nchar(word) > 3, !str_detect(word, "^\\d+$"))

word_counts <- abstract_tokens %>%
  count(id, word, sort = TRUE)

dtm <- word_counts %>%
  cast_dtm(document = id, term = word, value = n)

tibble(
  Metric = c("Documents", "Terms", "Non-zero entries"),
  Value = c(nrow(dtm), ncol(dtm), sum(as.matrix(dtm) > 0))
) %>% kable()
```

## Run LDA Model

Fit LDA with 20 topics using Gibbs sampling.

```{r run-lda}
set.seed(123)

lda_model <- LDA(
  dtm,
  k = 20,
  method = "Gibbs",
  control = list(iter = 2000, burnin = 500, seed = 123)
)
```

## Top Terms per Topic

```{r top-terms}
topic_terms <- tidy(lda_model, matrix = "beta")

top_terms <- topic_terms %>%
  group_by(topic) %>%
  slice_max(beta, n = 10) %>%
  ungroup() %>%
  arrange(topic, -beta)

top_terms %>%
  group_by(topic) %>%
  slice_head(n = 5) %>%
  summarise(terms = paste(term, collapse = ", "), .groups = "drop") %>%
  kable()
```

## Visualize Topic-Term Distributions

```{r visualize-terms, fig.width=12, fig.height=10}
top_terms %>%
  filter(topic <= 6) %>%
  group_by(topic) %>%
  slice_max(beta, n = 15) %>%
  ungroup() %>%
  mutate(term = reorder_within(term, beta, topic)) %>%
  ggplot(aes(x = term, y = beta, fill = as.factor(topic))) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ topic, scales = "free", ncol = 3) +
  scale_x_reordered() +
  coord_flip() +
  labs(
    title = "Top 15 Terms per Topic (Topics 1-6)",
    x = "Term",
    y = "Probability (beta)"
  ) +
  theme_minimal()
```

## Document-Topic Distributions

```{r doc-topics, fig.width=10, fig.height=5}
doc_topics <- tidy(lda_model, matrix = "gamma") %>%
  rename(id = document)

dominant_topics <- doc_topics %>%
  group_by(id) %>%
  slice_max(gamma, n = 1) %>%
  ungroup()

topic_summary <- dominant_topics %>%
  count(topic, name = "n_docs") %>%
  mutate(percentage = round(n_docs / sum(n_docs) * 100, 1)) %>%
  arrange(desc(n_docs))

ggplot(topic_summary, aes(x = reorder(as.factor(topic), -n_docs), y = n_docs)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = paste0(n_docs, "\n(", percentage, "%)")),
            vjust = -0.3, size = 3) +
  labs(
    title = "Document Distribution Across Topics",
    subtitle = "Based on dominant topic assignment",
    x = "Topic",
    y = "Number of Documents"
  ) +
  theme_minimal()

topic_summary %>% kable()
```

## Save Results

```{r save-results}
lda_file <- file.path(data_dir, "lda_model_k20.rds")
saveRDS(lda_model, lda_file)

topic_assignments <- fusarium_data %>%
  select(id, title, abstract_clean) %>%
  left_join(dominant_topics, by = "id")

assignments_file <- file.path(data_dir, "topic_assignments_k20.rds")
saveRDS(topic_assignments, assignments_file)

top_terms_file <- file.path(data_dir, "lda_top_terms_k20.csv")
write.csv(top_terms, top_terms_file, row.names = FALSE)

tibble(
  Output = c("LDA model", "Topic assignments", "Top terms"),
  Path = c(lda_file, assignments_file, top_terms_file)
) %>% kable()
```

## Summary

```{r summary}
tibble(
  Parameter = c("Number of topics", "Documents", "Terms", "Algorithm"),
  Value = c(lda_model@k, nrow(dtm), ncol(dtm), "Gibbs sampling (2000 iterations)")
) %>% kable()
```

## Next Steps

Proceed to `0210_topic_interpretation.Rmd` to manually label and interpret topics.
