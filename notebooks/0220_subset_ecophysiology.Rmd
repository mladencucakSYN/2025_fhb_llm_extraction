---
title: "Subset to Ecophysiology Topics"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(knitr)
```

## Overview

This notebook filters the full dataset to studies focused on ecophysiology and abiotic responses, reducing the corpus for targeted extraction.

## Load Packages and Data

```{r load-packages}
library(dplyr)
library(ggplot2)
library(readr)

data_dir <- "../data/fusarium"
```

```{r load-data}
fusarium_data <- readRDS(file.path(data_dir, "fusarium_studies_extraction_ready.rds"))
topic_assignments <- readRDS(file.path(data_dir, "topic_assignments_k20.rds"))
topic_labels <- read_csv(file.path(data_dir, "topic_labels.csv"), show_col_types = FALSE)

tibble(
  Dataset = c("Full corpus", "Topic assignments", "Topic labels"),
  Records = c(nrow(fusarium_data), nrow(topic_assignments), nrow(topic_labels))
) %>% kable()
```

## Identify Ecophysiology Topics

Dynamically identify ecophysiology topics from the topic labels file based on macro_theme.

```{r identify-topics}
ecophys_topics <- topic_labels %>%
  filter(macro_theme == "Ecophysiology") %>%
  pull(topic)

tibble(
  `Macro Theme` = "Ecophysiology",
  `Topic Count` = length(ecophys_topics),
  `Topic IDs` = paste(ecophys_topics, collapse = ", ")
) %>% kable()
```

## Filter to Ecophysiology Studies

Select studies where the dominant topic is in the ecophysiology macro-theme.

```{r filter-ecophysiology}
<<<<<<< HEAD
# Ecophysiology topics: 2, 5, 8, 10, 11, 13
ecophys_topics <- c(1, 10, 12, 13, 16, 17, 18)

=======
>>>>>>> origin/main
ecophys_studies <- topic_assignments %>%
  filter(topic %in% ecophys_topics) %>%
  left_join(topic_labels %>% select(topic, label, macro_theme), by = "topic")

tibble(
  Metric = c("Original dataset", "Ecophysiology subset", "Reduction"),
  Value = c(
    nrow(fusarium_data),
    nrow(ecophys_studies),
    paste0(round((1 - nrow(ecophys_studies)/nrow(fusarium_data)) * 100, 1), "%")
  )
) %>% kable()
```

## Topic Distribution

```{r topic-distribution, fig.width=10, fig.height=5}
topic_dist <- ecophys_studies %>%
  count(topic, label, name = "n_studies") %>%
  arrange(desc(n_studies))

ggplot(topic_dist, aes(x = reorder(label, n_studies), y = n_studies)) +
  geom_col(fill = "darkgreen", alpha = 0.7) +
  geom_text(aes(label = n_studies), hjust = -0.2) +
  coord_flip() +
  labs(
    title = "Studies per Ecophysiology Topic",
    x = "Topic",
    y = "Number of Studies"
  ) +
  theme_minimal()

topic_dist %>% kable()
```

## Save Filtered Dataset

```{r save-filtered}
ecophys_file <- file.path(data_dir, "fusarium_ecophysiology_subset.rds")
saveRDS(ecophys_studies, ecophys_file)

tibble(
  Output = "Ecophysiology subset",
  Path = ecophys_file,
  Records = nrow(ecophys_studies)
) %>% kable()
```

## Next Steps

Proceed to `0230_create_test_sample.Rmd` to create test samples for extraction development.
