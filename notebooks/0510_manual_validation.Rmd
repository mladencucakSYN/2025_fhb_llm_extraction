---
title: "Manual Validation Sample"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(knitr)
```

## Overview

This notebook guides the process of manually validating a sample of extractions to assess accuracy. Manual validation is essential for understanding extraction quality.

## Load Packages and Data

```{r load-packages}
library(dplyr)

data_dir <- "../data/fusarium"
```

```{r load-data}
all_results <- readRDS(file.path(data_dir, "batch_extraction_results_demo.rds"))

tibble(
  Dataset = "Extraction results",
  Records = nrow(all_results)
) %>% kable()
```

## Select Validation Sample

```{r select-sample}
set.seed(456)
validation_sample <- all_results %>%
  slice_sample(n = min(20, nrow(all_results)))

tibble(
  Metric = "Validation sample size",
  Value = nrow(validation_sample)
) %>% kable()
```

## Validation Instructions

For each document:

1. Read the title and abstract
2. Review the extracted information
3. Mark each field as: Correct, Partially Correct, or Incorrect
4. Note any missing information
5. Record in validation spreadsheet

## Sample Documents for Review

```{r display-for-review}
original_data <- readRDS(file.path(data_dir, "sample_10_studies.rds"))

validation_data <- validation_sample %>%
  left_join(original_data %>% select(id, title, abstract_clean), by = "id")

validation_data %>%
  head(3) %>%
  mutate(
    title_short = substr(title, 1, 50),
    species = sapply(fusarium_species, function(x) paste(x, collapse = ", ")),
    crops = sapply(crop, function(x) paste(x, collapse = ", "))
  ) %>%
  select(id, title_short, species, crops, modeling) %>%
  kable()
```

## Validation Template

```{r validation-template}
tibble(
  Field = c("Species", "Crops", "Abiotic Factors", "Mycotoxins", "Modeling", "Summary"),
  `Rating Options` = rep("Correct (1) / Partial (0.5) / Incorrect (0)", 6)
) %>% kable(caption = "Validation rating scale")
```

## Save Validation Template

```{r save-template}
validation_export <- validation_data %>%
  mutate(
    fusarium_species_str = sapply(fusarium_species, function(x) paste(x, collapse = "; ")),
    crop_str = sapply(crop, function(x) paste(x, collapse = "; ")),
    abiotic_factors_str = sapply(abiotic_factors, function(x) paste(x, collapse = "; "))
  ) %>%
  select(
    id, title, abstract_clean,
    fusarium_species_str, crop_str, abiotic_factors_str,
    modeling, summary
  )

validation_file <- file.path(data_dir, "validation_sample.csv")
write.csv(validation_export, validation_file, row.names = FALSE)

tibble(
  Output = "Validation template",
  Path = validation_file,
  Documents = nrow(validation_export)
) %>% kable()
```

## Validation Workflow

```{r workflow}
tibble(
  Step = 1:7,
  Task = c(
    "Open validation_sample.csv in spreadsheet software",
    "For each row, verify extracted data against abstract",
    "Add columns: species_correct, crop_correct, etc.",
    "Mark as: 1 (correct), 0.5 (partial), 0 (incorrect)",
    "Calculate accuracy: mean(species_correct)",
    "Identify patterns in errors",
    "Refine prompts if needed"
  )
) %>% kable(caption = "Manual validation workflow")
```

## Next Steps

Proceed to `0520_aggregate_results.Rmd` after completing manual validation.
