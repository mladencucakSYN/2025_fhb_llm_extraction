---
title: "Create Test Sample for Extraction"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(knitr)
```

## Overview

This notebook creates stratified test samples of different sizes for testing extraction before processing the full dataset.

## Load Packages and Data

```{r load-packages}
library(dplyr)
library(readr)

data_dir <- "../data/fusarium"
```

```{r load-data}
ecophys_data <- readRDS(file.path(data_dir, "fusarium_ecophysiology_subset.rds"))

tibble(
  Dataset = "Ecophysiology subset",
  Records = nrow(ecophys_data)
) %>% kable()
```

## Create Stratified Samples

Create samples of 10, 50, and 100 studies for iterative testing.

```{r create-samples}
set.seed(123)

sample_sizes <- c(10, 50, 100)
shuffled_data <- ecophys_data[sample(nrow(ecophys_data)), ]

sample_info <- tibble(
  Size = integer(),
  Actual = integer(),
  Path = character()
)

for (size in sample_sizes) {
  sample_data <- shuffled_data %>%
    group_by(topic) %>%
    slice_head(n = ceiling(size / n_distinct(ecophys_data$topic))) %>%
    ungroup()

  if (nrow(sample_data) > size) {
    sample_data <- sample_data[1:size, ]
  }

  sample_file <- file.path(data_dir, sprintf("sample_%d_studies.rds", size))
  saveRDS(sample_data, sample_file)

  sample_info <- bind_rows(sample_info, tibble(
    Size = size,
    Actual = nrow(sample_data),
    Path = sample_file
  ))
}

sample_info %>% kable()
```

## 10-Study Sample Characteristics

```{r sample-characteristics}
sample_10 <- readRDS(file.path(data_dir, "sample_10_studies.rds"))

sample_10 %>%
  count(topic, name = "n_studies") %>%
  kable(caption = "Topic distribution in 10-study sample")
```

## Sample Titles

```{r sample-titles}
sample_10 %>%
  mutate(
    n = row_number(),
    title_short = substr(title, 1, 70)
  ) %>%
  select(n, title_short) %>%
  kable()
```

## Summary

```{r summary}
full_corpus <- readRDS(file.path(data_dir, "fusarium_studies_extraction_ready.rds"))
sample_50 <- readRDS(file.path(data_dir, "sample_50_studies.rds"))
sample_100 <- readRDS(file.path(data_dir, "sample_100_studies.rds"))

tibble(
  Dataset = c("Full corpus", "Ecophysiology subset", "Sample (10)", "Sample (50)", "Sample (100)"),
  Studies = c(
    nrow(full_corpus),
    nrow(ecophys_data),
    nrow(sample_10),
    nrow(sample_50),
    nrow(sample_100)
  )
) %>% kable()
```

## Next Steps

Proceed to `0300_design_extraction_schema.Rmd` to design the extraction schema.
