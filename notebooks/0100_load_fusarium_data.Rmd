---
title: "Load Fusarium Head Blight Research Data"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(knitr)
```

## Overview

This notebook loads the Fusarium head blight literature dataset collected from Scopus and PubMed. The dataset contains bibliographic information and abstracts from scientific studies on Fusarium head blight in cereals under climate change conditions.

## Load Packages

```{r load-packages}
library(dplyr)
library(readr)
library(stringr)
library(ggplot2)
library(tidyr)
```

## Define Data Location

```{r data-location}
data_dir <- "../data/fusarium"
data_file <- file.path(data_dir, "fusarium_studies.csv")

tibble(
  Parameter = c("Data directory", "Data file", "Directory exists", "File exists"),
  Value = c(data_dir, data_file, dir.exists(data_dir), file.exists(data_file))
) %>% kable()
```

## Load Data

```{r load-data}
if (!file.exists(data_file)) {
  stop(paste("Data file not found:", data_file,
             "\nRun notebooks 0090 and 0095 first to fetch and merge the data."))
}

fusarium_data <- read_csv(
  data_file,
  col_types = cols(
    pmid = col_character(),
    id = col_character(),
    title = col_character(),
    abstract = col_character(),
    authors = col_character(),
    affiliations = col_character(),
    countries = col_character(),
    pub_year = col_integer(),
    journal = col_character(),
    doi = col_character(),
    keywords = col_character(),
    mesh_terms = col_character(),
    pub_types = col_character(),
    grants = col_character(),
    ref_count = col_integer(),
    source = col_character()
  )
)

fusarium_data <- fusarium_data %>%
  rename(year = pub_year, database = source)
```

## Dataset Overview

```{r dataset-overview}
tibble(
  Metric = c("Total records", "Columns", "File size (KB)"),
  Value = c(
    format(nrow(fusarium_data), big.mark = ","),
    ncol(fusarium_data),
    round(file.size(data_file) / 1024, 1)
  )
) %>% kable()
```

## Column Summary

```{r column-summary}
tibble(
  Column = names(fusarium_data),
  Type = sapply(fusarium_data, class),
  `Non-NA Count` = sapply(fusarium_data, function(x) sum(!is.na(x))),
  `NA Count` = sapply(fusarium_data, function(x) sum(is.na(x))),
  `NA %` = round(sapply(fusarium_data, function(x) mean(is.na(x)) * 100), 1)
) %>% kable()
```

## Publication Year Distribution

```{r year-distribution, fig.width=10, fig.height=5}
year_counts <- fusarium_data %>%
  filter(!is.na(year)) %>%
  count(year, name = "n_studies") %>%
  arrange(year)

ggplot(year_counts, aes(x = year, y = n_studies)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = n_studies), vjust = -0.5, size = 3) +
  scale_x_continuous(breaks = seq(min(year_counts$year), max(year_counts$year), by = 2)) +
  labs(
    title = "Publications by Year",
    x = "Year",
    y = "Number of Studies"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r year-summary}
year_counts %>%
  summarise(
    `Year Range` = paste(min(year), "-", max(year)),
    `Total Years` = n(),
    `Peak Year` = year[which.max(n_studies)],
    `Peak Count` = max(n_studies),
    `Mean per Year` = round(mean(n_studies), 1)
  ) %>% kable()
```

## Database Source Distribution

```{r database-distribution, fig.width=8, fig.height=4}
database_counts <- fusarium_data %>%
  count(database, name = "n_studies") %>%
  mutate(percentage = round(n_studies / sum(n_studies) * 100, 1)) %>%
  arrange(desc(n_studies))

ggplot(database_counts, aes(x = reorder(database, -n_studies), y = n_studies)) +
  geom_col(fill = "darkgreen") +
  geom_text(aes(label = paste0(n_studies, " (", percentage, "%)")),
            vjust = -0.5, size = 4) +
  labs(
    title = "Studies by Database Source",
    x = "Database",
    y = "Number of Studies"
  ) +
  theme_minimal()

database_counts %>% kable()
```

## Text Length Analysis

```{r text-lengths, fig.width=10, fig.height=5}
fusarium_data <- fusarium_data %>%
  mutate(
    title_length = nchar(title),
    abstract_length = nchar(abstract),
    total_text_length = title_length + abstract_length
  )

tibble(
  Field = c("Title", "Abstract", "Total"),
  `Mean Length` = c(
    round(mean(fusarium_data$title_length, na.rm = TRUE)),
    round(mean(fusarium_data$abstract_length, na.rm = TRUE)),
    round(mean(fusarium_data$total_text_length, na.rm = TRUE))
  ),
  `Median Length` = c(
    median(fusarium_data$title_length, na.rm = TRUE),
    median(fusarium_data$abstract_length, na.rm = TRUE),
    median(fusarium_data$total_text_length, na.rm = TRUE)
  ),
  `Min` = c(
    min(fusarium_data$title_length, na.rm = TRUE),
    min(fusarium_data$abstract_length, na.rm = TRUE),
    min(fusarium_data$total_text_length, na.rm = TRUE)
  ),
  `Max` = c(
    max(fusarium_data$title_length, na.rm = TRUE),
    max(fusarium_data$abstract_length, na.rm = TRUE),
    max(fusarium_data$total_text_length, na.rm = TRUE)
  )
) %>% kable()

ggplot(fusarium_data, aes(x = abstract_length)) +
  geom_histogram(bins = 50, fill = "coral", alpha = 0.7) +
  geom_vline(aes(xintercept = median(abstract_length, na.rm = TRUE)),
             color = "red", linetype = "dashed", linewidth = 1) +
  labs(
    title = "Distribution of Abstract Lengths",
    subtitle = paste("Median:", median(fusarium_data$abstract_length, na.rm = TRUE), "characters"),
    x = "Abstract Length (characters)",
    y = "Count"
  ) +
  theme_minimal()
```

## Duplicate Check

```{r check-duplicates}
title_duplicates <- fusarium_data %>%
  filter(!is.na(title)) %>%
  group_by(title) %>%
  filter(n() > 1) %>%
  ungroup()

doi_duplicates <- fusarium_data %>%
  filter(!is.na(doi)) %>%
  group_by(doi) %>%
  filter(n() > 1) %>%
  ungroup()

tibble(
  Check = c("Title duplicates", "DOI duplicates"),
  Count = c(nrow(title_duplicates), nrow(doi_duplicates)),
  Status = c(
    ifelse(nrow(title_duplicates) == 0, "OK", "Review needed"),
    ifelse(nrow(doi_duplicates) == 0, "OK", "Review needed")
  )
) %>% kable()
```

## Save Processed Data

```{r save-data}
summary_stats <- list(
  total_records = nrow(fusarium_data),
  date_loaded = as.character(Sys.Date()),
  year_range = paste(range(fusarium_data$year, na.rm = TRUE), collapse = "-"),
  databases = paste(unique(fusarium_data$database), collapse = ", "),
  missing_abstracts = sum(is.na(fusarium_data$abstract)),
  mean_abstract_length = round(mean(fusarium_data$abstract_length, na.rm = TRUE))
)

summary_file <- file.path(data_dir, "data_summary.txt")
writeLines(yaml::as.yaml(summary_stats), summary_file)

processed_file <- file.path(data_dir, "fusarium_studies_loaded.rds")
saveRDS(fusarium_data, processed_file)

tibble(
  Output = c("Summary file", "Processed data"),
  Path = c(summary_file, processed_file),
  Status = c(
    ifelse(file.exists(summary_file), "Saved", "Failed"),
    ifelse(file.exists(processed_file), "Saved", "Failed")
  )
) %>% kable()
```

## Summary

```{r final-summary}
tibble(
  Metric = c(
    "Total Studies",
    "Publication Years",
    "Databases",
    "Missing Abstracts",
    "Mean Abstract Length"
  ),
  Value = c(
    format(nrow(fusarium_data), big.mark = ","),
    paste(range(fusarium_data$year, na.rm = TRUE), collapse = " - "),
    paste(unique(fusarium_data$database), collapse = ", "),
    sum(is.na(fusarium_data$abstract)),
    paste(round(mean(fusarium_data$abstract_length, na.rm = TRUE)), "chars")
  )
) %>% kable()
```

## Next Steps

Proceed to `0110_preprocess_abstracts.Rmd` for text cleaning and preparation.
