---
title: "Topic Interpretation and Labeling"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(knitr)
```

## Overview

This notebook guides manual interpretation of LDA topics, creating human-readable labels and grouping topics into macro-themes.

## Load Packages and Data

```{r load-packages}
library(dplyr)
library(ggplot2)
library(readr)
library(tidyr)

data_dir <- "../data/fusarium"
```

```{r load-results}
topic_assignments <- readRDS(file.path(data_dir, "topic_assignments_k20.rds"))
top_terms <- read_csv(file.path(data_dir, "lda_top_terms_k20.csv"), show_col_types = FALSE)

tibble(
  Data = c("Topic assignments", "Top terms"),
  Records = c(nrow(topic_assignments), nrow(top_terms))
) %>% kable()
```

## Review Top Terms by Topic

```{r review-topics}
topic_terms_summary <- top_terms %>%
  group_by(topic) %>%
  slice_head(n = 10) %>%
  summarise(terms = paste(term, collapse = ", "), .groups = "drop")

topic_terms_summary %>% kable()
```

## Get Number of Topics from Data

```{r get-n-topics}
n_topics <- n_distinct(top_terms$topic)

tibble(
  Parameter = "Number of topics (k)",
  Value = n_topics
) %>% kable()
```

## Sample Documents per Topic

```{r sample-docs}
sample_titles <- topic_assignments %>%
  group_by(topic) %>%
  slice_head(n = 2) %>%
  mutate(title_short = substr(title, 1, 60)) %>%
  summarise(sample_titles = paste(title_short, collapse = " | "), .groups = "drop")

sample_titles %>% kable()
```

## Assign Topic Labels

Based on reviewing top terms and sample documents, assign interpretable labels.
This is manual expert labeling based on domain knowledge.

```{r label-topics}
# Define labels based on top terms review
# NOTE: This is the source of truth - labels are manually assigned here
# and saved to topic_labels.csv for use in downstream notebooks

topic_labels <- tibble(
  topic = 1:n_topics,
  label = c(
<<<<<<< HEAD
    "Climate & Environmental Impacts",                      # 1
    "Mycotoxin Contamination & Food Saftey",                # 2
    "Maize Fusarium",                                       # 3
    "Disease Control & Seed Control",                       # 4
    "Biocontrol Agents & Antifungal Activity",              # 5
    "Modelling",                                            # 6
    "Soil Microbial Communities & Ecology",                 # 7
    "Fusarium Identification & Diversity",                  # 8
    "Genetic Resistance in Wheat",                          # 9
    "Fungal Growth, Pathogenicity & Molecular Biology",     # 10
    "Leaf Diseases & Wheat Cultivar Registration",          # 11
    "Plantâ€“Pathogen Interactions & Host Response",          # 12
    "Gene Expression & Stress-Response Pathways",           # 13
    "Metabolites, Toxins & Health-Related Effects",         # 14
    "Fusarium Head Blight in Wheat",                        # 15
    "Plant Stress Physiology & Growth Effects",             # 16
    "Fusarium Growth Under Environmental Conditions",       # 17
    "Grain Quality, Yield & Weather Impacts",               # 18
    "Enzymes, Degradation & Chemical Properties",           # 19
    "Soil Health, Cropping Systems & Root Diseases"         # 20
=======
    "General Fusarium Biology",
    "Temperature and Growth",
    "Wheat Pathology",
    "Fungicide Control",
    "Moisture and Infection",
    "DON Mycotoxin Production",
    "Field Studies and Epidemiology",
    "Climate Factors",
    "Barley and Malt Quality",
    "Temperature Models",
    "Environmental Conditions",
    "Disease Severity Assessment",
    "Abiotic Stress Interactions",
    "Molecular Biology",
    "Crop Resistance",
    "Soil and Crop Rotation",
    "Maize Fusarium",
    "Food Safety and Regulations",
    "Prediction Models",
    "Management Practices"
  )[1:n_topics]
)

topic_labels %>% kable()
```

## Define Macro-Themes

Group topics into broader research themes for filtering.

```{r define-macro-themes}
# Define macro-theme assignments
# NOTE: This defines the groupings - downstream notebooks read from saved file

macro_theme_definitions <- tibble(
  macro_theme = c(
    rep("Ecophysiology", 6),
    rep("Disease Epidemiology", 4),
    rep("Disease Management", 4),
    rep("Mycotoxins & Food Safety", 4),
    rep("Basic Biology & Molecular", 2)
  ),
  topic = c(
    2, 5, 8, 10, 11, 13,
    3, 7, 12, 19,
    4, 15, 16, 20,
    6, 9, 17, 18,
    1, 14
>>>>>>> origin/main
  )
)

# Join with labels
topic_labels <- topic_labels %>%
  left_join(macro_theme_definitions, by = "topic")

topic_labels %>%
  select(topic, label, macro_theme) %>%
  kable()
```

## Macro-Theme Summary

<<<<<<< HEAD
## Group Topics into Macro-Themes

Group the 20 topics into 5 broader macro-themes.

```{r macro-themes}
topic_labels <- topic_labels %>%
  mutate(
    macro_theme = case_when(
      topic %in% c(1, 10, 12, 13, 16, 17, 18) ~ "Ecophysiology & Abiotic Responses",
      topic %in% c(3, 7, 12, 19) ~ "Disease Epidemiology",
      topic %in% c(4, 15, 16, 20) ~ "Disease Management",
      topic %in% c(6, 9, 17, 18) ~ "Mycotoxins & Food Safety",
      topic %in% c(1, 14) ~ "Basic Biology & Molecular"
    )
  )

# Summary by macro-theme
=======
```{r macro-themes, fig.width=10, fig.height=5}
>>>>>>> origin/main
macro_summary <- topic_labels %>%
  count(macro_theme, name = "n_topics")

ggplot(macro_summary, aes(x = reorder(macro_theme, n_topics), y = n_topics)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = n_topics), hjust = -0.2) +
  coord_flip() +
  labs(
    title = "Topics per Macro-Theme",
    x = "Macro-Theme",
    y = "Number of Topics"
  ) +
  theme_minimal()

macro_summary %>% kable()
```

## Topics by Macro-Theme

```{r topics-by-theme}
topic_labels %>%
  select(macro_theme, topic, label) %>%
  arrange(macro_theme, topic) %>%
  kable()
```

## Ecophysiology Topics

Topics relevant to climate-Fusarium interactions research.

```{r ecophysiology-topics}
ecophys_topics <- topic_labels %>%
  filter(macro_theme == "Ecophysiology")

ecophys_topics %>% kable()
```

## Save Labeled Topics

This file is the source of truth for downstream notebooks.

```{r save-labels}
labels_file <- file.path(data_dir, "topic_labels.csv")
write_csv(topic_labels, labels_file)

tibble(
  Output = "Topic labels",
  Path = labels_file,
  Records = nrow(topic_labels),
  Note = "Source of truth for topic labels and macro-themes"
) %>% kable()
```

## Next Steps

Proceed to `0220_subset_ecophysiology.Rmd` to filter the dataset to ecophysiology topics.
That notebook will read `topic_labels.csv` to dynamically identify relevant topics.
